<!doctype html>
<html lang="en">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='single_page.css') }}"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <!--<script type"text/javascript" src="{{ url_for('static', filename='squeezebox_mqtt.js') }}"/>-->
  <script> //TODO: extract script to static file (with versioning to force reload)
    var mqtt;
    var reconnectTimeout = 2000;
    var host = "{{ mqtt_broker_host }}";
    var port = {{ mqtt_broker_port }};
    
    //TODO: replace getElementById lookups with globals for fixed elements?
    var selected_player_id = null;

    function onConnect(){
      console.log("Connected");
      mqtt.subscribe("squeezebox/players/+");
      // TODO: replace *-get with web service call?
      var message = new Paho.MQTT.Message("");
      message.destinationName = "squeezebox/players-get";
      mqtt.send(message);
    }

    function onFailure(msg){
      console.log("Connection attempt to " + host + ":" + port + " failed.");
      setTimeout(MQTTConnect, reconnectTimeout);
    }

    function onMessageArrived(msg){
      console.log("Message received on topic: ", msg.destinationName);
      var topic = msg.destinationName.split('/');
      if(topic[0] == 'squeezebox'){
        var json_msg = JSON.parse(msg.payloadString);
        if(topic[1] == 'players'){
          renderPlayer(json_msg);
          renderPlaylist(json_msg);
        }
      }
    }

    function player_command(player_id, cmd){
      var msg = new Paho.MQTT.Message(cmd)
      msg.destinationName = 'squeezebox/players/' + player_id + '/command';
      mqtt.send(msg);
    }

    function show_hide_played(){
      var show_played = document.getElementById("show-played-tracks").checked;
      var playlists = document.getElementById("playlists");
      var tracks = playlists.getElementsByClassName("played");
      for(var i = 0; i < tracks.length; i++){
        if(show_played){
          tracks[i].style.display = null;
        }else{
          tracks[i].style.display = "none";
        }
      }
    }

    function renderPlaylist(json_player){
      console.log("Rendering playlist for", json_player.id);
      if(!document.getElementById("playlist-" + json_player.id)){
        console.log("Creating new playlist...");
        var all_playlists = document.getElementById("playlists");
        var playlist = document.createElement("div");
        playlist.id = "playlist-" + json_player.id;
        playlist.className = "playlist";
        playlist.style.display = "none";
        all_playlists.appendChild(playlist);
      }
      var playlist = document.getElementById("playlist-" + json_player.id);
      playlist.innerHTML = "";
      for(var track in json_player.playlist){
        var album = json_player.playlist[track].album;
        if(!album){
          album = json_player.playlist[track].title;
        }
        var div_track = document.createElement("div");
        if(json_player.playlist[track].index < json_player.playlist_current_index){
          div_track.className = "played track";
        }else if(json_player.playlist[track].index == json_player.playlist_current_index){
          div_track.className = "current track";
        }else{
          div_track.className = "track";
        }
        div_track.innerHTML = 
          "<div class=index>" + json_player.playlist[track].index + "</div>" +
          "<div class=title>" + json_player.playlist[track].title + "</div>" +
          "<div class=album>" + album + "</div>" +
          "<div class=artist>" + json_player.playlist[track].artist + "</div>";
        playlist.appendChild(div_track);
      }
      show_hide_played();
    }

    function player_selected(player_id){
      console.log("player_selected:", player_id);
      selected_player_id = player_id;
      var playlists = document.getElementById("playlists");
      var playlist_elements = playlists.getElementsByClassName("playlist");
      for(var i = 0; i < playlist_elements.length; i++){
        playlist_elements[i].style.display = "none";
      }
      document.getElementById("playlist-" + player_id).style.display = "table";
    }

    function renderPlayer(json_player){
      console.log("Player to render:", json_player)
      if(!document.getElementById("player-row-" + json_player.id)){
        // add a row for this player
        console.log("Adding row for ", json_player.id, "...");
        var table_players = document.getElementById("players-list");
        var row_player = document.createElement("div");
        row_player.id = "player-row-" + json_player.id;
        row_player.className = "player";
        table_players.appendChild(row_player);
        var playback = document.createElement("div");
        playback.className = "playback";
        playback.innerHTML = 
          "<input type=radio name=player-select onchange=\"player_selected('" + json_player.id + "')\"/>" +
          "<button type=button onclick=\"player_command('" + json_player.id + "','track_previous')\">|&lt;</button>" +
          "<button type=button id=\"play-pause-" + json_player.id + "\">...</button>" +
          "<button type=button onclick=\"player_command('" + json_player.id + "','track_next')\">&gt;|</button>";
        row_player.appendChild(playback);
        var volume = document.createElement("div");
        volume.className = "volume";
        volume.innerHTML = 
          "<button type=button onclick=\"player_command('" + json_player.id + "','volume_inc')\">^</button>" +
          "<button id=player-volume-" + json_player.id + " >...</button>" +
          "<button type=button onclick=\"player_command('" + json_player.id + "','volume_dec')\">v</button>";
        row_player.appendChild(volume);
        var player_location = document.createElement("div");
        player_location.id = "player-location-" + json_player.id;
        player_location.className = "location";
        row_player.appendChild(player_location);
        var title = document.createElement("div");
        title.id = "player-title-" + json_player.id;
        title.className = "title";
        title.innerHTML = json_player.track;
        row_player.appendChild(title);
        var artist = document.createElement("div");
        artist.id = "player-artist-" + json_player.id;
        artist.className = "artist";
        artist.innerHTML = json_player.artist;
        row_player.appendChild(artist);
        var album = document.createElement("div");
        album.id = "player-album-" + json_player.id;
        album.className = "album";
        row_player.appendChild(album);
      }
      // update values
      document.getElementById("player-volume-" + json_player.id).innerHTML = json_player.volume;
      document.getElementById("player-location-" + json_player.id).innerHTML = json_player.name;
      document.getElementById("player-artist-" + json_player.id).innerHTML = json_player.artist;
      if(json_player.album){
        document.getElementById("player-album-" + json_player.id).innerHTML = json_player.album;
      }else{
        document.getElementById("player-album-" + json_player.id).innerHTML = json_player.title;
      }
      var play_pause = document.getElementById("play-pause-" + json_player.id);
      if(json_player.mode == "play"){
        play_pause.innerHTML = "pause";
        play_pause.onclick = function() { player_command(json_player.id, "pause"); };
      }else{
        play_pause.innerHTML = "play";
        play_pause.onclick = function() { player_command(json_player.id, "play"); };
      }
    }

    function MQTTConnect(){
      console.log("Connecting to {{ mqtt_broker_host }}:{{ mqtt_bocker_port }}...");
      mqtt = new Paho.MQTT.Client(host, port, "js-single-page"); //TODO: make the name unique
      var options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: onFailure,
      };
      mqtt.onMessageArrived = onMessageArrived;
      mqtt.connect(options);
    }

    function add_breadcrumb(text, onclick_handler){
      console.log("add_breadcrumb:", text, onclick_handler);
      var breadcrumbs = document.getElementById("library-breadcrumb");
      breadcrumbs.innerHTML += " &gt; ";
      var breadcrumb = document.createElement("a");
      breadcrumb.innerHTML = text;
      breadcrumb.onclick = onclick_handler;
      breadcrumbs.appendChild(breadcrumb);
    }

    function library_artists(){
      console.log("library_artists");
      var div_artists = document.getElementById("library-artists");
      if(!div_artists || (div_artists.style.display == "none")){
        library_hide_content();
        add_breadcrumb("Artists", library_artists);
        if(div_artists){
          div_artists.style.display = null;
        }else{
          var library = document.getElementById("library-content");
          div_artists = document.createElement("div");
          div_artists.id = "library-artists";
          library.appendChild(div_artists);
          var request = new XMLHttpRequest();
          request.onload = function(){ add_artists(div_artists, JSON.parse(request.responseText)); }
          request.open("GET", "/api/library/artists", true);
          request.setRequestHeader("Content-Type", "application/json");
          request.send();
        }
      }
    }

    function add_artists(div_artists, json_artists){
      console.log("add_artists:", json_artists);
      for(var i = 0; i < json_artists.length; i++){
        var div_artist = document.createElement("div");
        div_artist.innerHTML = "<a onclick=\"library_artist_albums(" + json_artists[i].id + ", '" + json_artists[i].name + "')\">" + json_artists[i].name + "</a>"; 
        div_artists.appendChild(div_artist);
      }
    }

    function library_artist_albums(artist_id, artist_name){
      console.log("library_artist_albumss:", artist_id, artist_name);
      var div_artist_albums = document.getElementById("library-artist-" + artist_id + "-albums");
      if(!div_artist_albums || (div_artist_albums.style.display == "none")){
        library_hide_content();
        add_breadcrumb(artist_name, function(){ library_artist_albums(artist_id, artist_name) });
        if(div_artist_albums){
          div_artist_albums.style.display = null;
        }else{
          var library = document.getElementById("library-content");
          div_albums = document.createElement("div");
          div_albums.id = "library-artist-" + artist_id + "-albums";
          library.appendChild(div_albums);
          var request = new XMLHttpRequest();
          request.onload = function(){ add_artist_albums(div_albums, JSON.parse(request.responseText)); }
          request.open("GET", "/api/library/albums?artist_id=" + artist_id, true);
          request.setRequestHeader("Content-Type", "application/json");
          request.send();
        }
      }
    }

    function add_artist_albums(div_albums, json_albums){
      for(var i = 0; i < json_albums.length; i++){
        var div_album = document.createElement("div");
        div_album.innerHTML = "<a onclick=\"library_album_tracks(" + json_albums[i].id + ", '" + json_albums[i].name + "')\">" + json_albums[i].name + "</a>";
        div_albums.appendChild(div_album);
      }
    }

    function library_album_tracks(album_id, album_name){
      var div_album_tracks = document.getElementById("library-album-" + album_id + "-tracks");
      if(!div_album_tracks){
        // create div & populate
        var library = document.getElementById("library-content");
        div_album_tracks = document.createElement("div");
        div_album_tracks.id = "library-artist-" + album_id + "-albums";
        div_album_tracks.className = "track-list";
        library.appendChild(div_album_tracks);
        var request = new XMLHttpRequest();
        request.onload = function(){ add_album_tracks(div_album_tracks, JSON.parse(request.responseText)); }
        request.open("GET", "/api/library/tracks?album_id=" + album_id, true);
        request.setRequestHeader("Content-Type", "application/json");
          request.send();
      }
      library_hide_content();
      div_album_tracks.style.display = null;
      add_breadcrumb(album_name, function(){ library_album_tracks(album_id, album_name) });
    }

    function add_album_tracks(div_album_tracks, json_tracks){
      console.log("add_album_tracks:", json_tracks);
      for(var i = 0; i < json_tracks.length; i++){
        var div_track = document.createElement("div");
        div_track.className = "track"
        div_track.innerHTML = 
          "<div class='title'>" + json_tracks[i].title + "</div>" +
          "<div class=playback>" +
            "<button type=button title='Play' onclick='playlist_play(\"track\", " + json_tracks[i].id + ")'>&gt;</button>" +
            "<button type=button title='Add to playlist'>+</button>" +
          "</div>";
        div_album_tracks.appendChild(div_track);
      }
    }

    function library_hide_content(){
      var library_contents = document.getElementById("library-content").children;
      for(var i = 0; i < library_contents.length; i++){
        library_contents[i].style.display = "none";
      }
    }

    function library_home(){
      library_hide_content();
      document.getElementById("library-categories").style.display = null;
      var breadcrumbs = document.getElementById("library-breadcrumb");
      while(breadcrumbs.lastChild.className != "breadcrumb-root"){
        breadcrumbs.removeChild(breadcrumbs.lastChild);
      }
    }

    function playlist_play(type, id){
      // find selected player
      //var player_selector = document.querySelector("input[name='player-select']");
      console.log("playlist_play:", type, id);
      var request = new XMLHttpRequest();
      request.open("POST", "/api/players/" + selected_player_id + "/playlist/play", true);
      request.setRequestHeader("Content-Type", "application/json");
      var json = JSON.stringify({type: type, id: id});
      request.send(json);
    }
    
  </script>
  <head>
    <title>Now Playing...</title>
  </head>
  <body>
    <script>
      MQTTConnect();
    </script>
    <div class=page>
      <div id="players-list"i class=players>
        <h1>Players</h1>
      </div>
      <div class=row>
        <div id=playlists class="column playlist">
          <h1>Playlist</h1>
          <div>Show played tracks<input type=checkbox id="show-played-tracks" onclick="show_hide_played()"/></div>
        </div>
        <div class="column library">
          <div id="library-breadcrumb" class="breadcrumb">
            <a class="breadcrumb-root" onclick="library_home()">Categories</a>
          </div>
          <div id="library-content">
            <div id="library-categories">       
              <div>
                <a class="category" onclick="library_artists()">Artists</a>
              </div>
              <div>
                <a class="category" >Albums<a/>
              </div>
              <div>
                <a class="category" >Tracks<a/>
              </div>
              <div>
                <a class="category" >Years<a/>
              </div>
              <div>
                <a class="category" >New Music<a/>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
