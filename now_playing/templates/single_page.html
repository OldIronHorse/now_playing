<!doctype html>
<html lang="en">
  <link rel=stylesheet type=text/css href="{{ url_for('static', filename='single_page.css') }}"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <script> //TODO: extract script to static file (with versioning to force reload)
    var mqtt;
    var reconnectTimeout = 2000;
    var host = "{{ mqtt_broker_host }}";
    var port = {{ mqtt_broker_port }};

    function onConnect(){
      console.log("Connected");
      mqtt.subscribe("squeezebox/players/+");
      // TODO: replace *-get with web service call?
      var message = new Paho.MQTT.Message("");
      message.destinationName = "squeezebox/players-get";
      mqtt.send(message);
    }

    function onFailure(msg){
      console.log("Connection attempt to " + host + ":" + port + " failed.");
      setTimeout(MQTTConnect, reconnectTimeout);
    }

    function onMessageArrived(msg){
      console.log("Message received on topic: ", msg.destinationName);
      var topic = msg.destinationName.split('/');
      if(topic[0] == 'squeezebox'){
        var json_msg = JSON.parse(msg.payloadString);
        if(topic[1] == 'players'){
          renderPlayer(json_msg);
          renderPlaylist(json_msg);
        }
      }
    }

    function player_command(player_id, cmd){
      var msg = new Paho.MQTT.Message(cmd)
      msg.destinationName = 'squeezebox/players/' + player_id + '/command';
      mqtt.send(msg);
    }

    function show_hide_played(){
      var show_played = document.getElementById("show-played-tracks").checked;
      var playlists = document.getElementById("playlists");
      var tracks = playlists.getElementsByClassName("played");
      for(var i = 0; i < tracks.length; i++){
        if(show_played){
          tracks[i].style.display = null;
        }else{
          tracks[i].style.display = "none";
        }
      }
    }

    function renderPlaylist(json_player){
      console.log("Rendering playlist for", json_player.id);
      if(!document.getElementById("playlist-" + json_player.id)){
        console.log("Creating new playlist...");
        var all_playlists = document.getElementById("playlists");
        var playlist = document.createElement("div");
        playlist.id = "playlist-" + json_player.id;
        playlist.className = "playlist";
        playlist.style.display = "none";
        all_playlists.appendChild(playlist);
      }
      var playlist = document.getElementById("playlist-" + json_player.id);
      playlist.innerHTML = "";
      for(var track in json_player.playlist){
        var album = json_player.playlist[track].album;
        if(!album){
          album = json_player.playlist[track].title;
        }
        var div_track = document.createElement("div");
        if(json_player.playlist[track].index < json_player.playlist_current_index){
          div_track.className = "played track";
        }else if(json_player.playlist[track].index == json_player.playlist_current_index){
          div_track.className = "current track";
        }else{
          div_track.className = "track";
        }
        div_track.innerHTML = 
          "<div class=index>" + json_player.playlist[track].index + "</div>" +
          "<div class=title>" + json_player.playlist[track].title + "</div>" +
          "<div class=album>" + album + "</div>" +
          "<div class=artist>" + json_player.playlist[track].artist + "</div>";
        playlist.appendChild(div_track);
      }
      show_hide_played();
    }

    function player_selected(player_id){
      console.log("player_selected:", player_id);
      var playlists = document.getElementById("playlists");
      var playlist_elements = playlists.getElementsByClassName("playlist");
      for(var i = 0; i < playlist_elements.length; i++){
        playlist_elements[i].style.display = "none";
      }
      document.getElementById("playlist-" + player_id).style.display = "table";
    }

    function renderPlayer(json_player){
      console.log("Player to render:", json_player)
      if(!document.getElementById("player-row-" + json_player.id)){
        // add a row for this player
        console.log("Adding row for ", json_player.id, "...");
        var table_players = document.getElementById("players-list");
        var row_player = document.createElement("div");
        row_player.id = "player-row-" + json_player.id;
        row_player.className = "player";
        table_players.appendChild(row_player);
        var playback = document.createElement("div");
        playback.className = "playback";
        playback.innerHTML = 
          "<input type=radio name=player-select onchange=\"player_selected('" + json_player.id + "')\"/>" +
          "<button type=button onclick=\"player_command('" + json_player.id + "','track_previous')\">|&lt;</button>" +
          "<button type=button id=\"play-pause-" + json_player.id + "\">...</button>" +
          "<button type=button onclick=\"player_command('" + json_player.id + "','track_next')\">&gt;|</button>";
        row_player.appendChild(playback);
        var volume = document.createElement("div");
        volume.className = "volume";
        volume.innerHTML = 
          "<button type=button onclick=\"player_command('" + json_player.id + "','volume_inc')\">^</button>" +
          "<button id=player-volume-" + json_player.id + " >...</button>" +
          "<button type=button onclick=\"player_command('" + json_player.id + "','volume_dec')\">v</button>";
        row_player.appendChild(volume);
        var player_location = document.createElement("div");
        player_location.id = "player-location-" + json_player.id;
        player_location.className = "location";
        row_player.appendChild(player_location);
        var title = document.createElement("div");
        title.id = "player-title-" + json_player.id;
        title.className = "title";
        title.innerHTML = json_player.track;
        row_player.appendChild(title);
        var artist = document.createElement("div");
        artist.id = "player-artist-" + json_player.id;
        artist.className = "artist";
        artist.innerHTML = json_player.artist;
        row_player.appendChild(artist);
        var album = document.createElement("div");
        album.id = "player-album-" + json_player.id;
        album.className = "album";
        row_player.appendChild(album);
      }
      // update values
      document.getElementById("player-volume-" + json_player.id).innerHTML = json_player.volume;
      document.getElementById("player-location-" + json_player.id).innerHTML = json_player.name;
      document.getElementById("player-artist-" + json_player.id).innerHTML = json_player.artist;
      if(json_player.album){
        document.getElementById("player-album-" + json_player.id).innerHTML = json_player.album;
      }else{
        document.getElementById("player-album-" + json_player.id).innerHTML = json_player.title;
      }
      var play_pause = document.getElementById("play-pause-" + json_player.id);
      if(json_player.mode == "play"){
        play_pause.innerHTML = "pause";
        play_pause.onclick = function() { player_command(json_player.id, "pause"); };
      }else{
        play_pause.innerHTML = "play";
        play_pause.onclick = function() { player_command(json_player.id, "play"); };
      }
    }

    function MQTTConnect(){
      console.log("Connecting to {{ mqtt_broker_host }}:{{ mqtt_bocker_port }}...");
      mqtt = new Paho.MQTT.Client(host, port, "js-single-page"); //TODO: make the name unique
      var options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: onFailure,
      };
      mqtt.onMessageArrived = onMessageArrived;
      mqtt.connect(options);
    }
    
  </script>
  <head>
    <title>Now Playing...</title>
  </head>
  <body>
    <script>
      MQTTConnect();
    </script>
    <div class=page>
      <div id="players-list"i class=player>
        <h1>Players</h1>
      </div>
      <div class=row>
        <div id=playlists class="column playlist">
          <h1>Playlist</h1>
          <div>Show played tracks<input type=checkbox id="show-played-tracks" onclick="show_hide_played()"/></div>
        </div>
        <div class="column library">
          <h1>Library</h1>
          <p>
            Artists<br/>
            Albums<br/>
            Tracks<br/>
            Years<br/>
            New Music<br/>
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
